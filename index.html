<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Curling Pro Final</title>
    <style>
        :root {
            /* Palette */
            --blue: #0A84FF;
            --green: #30D158; /* ONLY for Tee Line */
            --red: #FF453A;
            --grey: #98989D;
            --dim: #3A3A3C;
            --bg: #000000;
            --surface: #1C1C1E;
            --border: #2C2C2E;
            --text: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- Header --- */
        header {
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
            background: var(--surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 20;
        }
        h1 { margin: 0; font-size: 17px; font-weight: 700; opacity: 0.9; }
        
        .profile-select {
            background: #2C2C2E;
            color: var(--blue);
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            outline: none;
            text-align-last: right;
            appearance: none;
        }

        /* --- Scroll Content --- */
        .scroll-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 150px;
        }

        /* --- Readout --- */
        .readout {
            padding: 20px 15px;
            background: linear-gradient(180deg, #1C1C1E 0%, #000000 100%);
        }

        .dual-pred {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .pred-card {
            background: #222;
            border-radius: 16px;
            padding: 16px 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 110px;
            border: 2px solid transparent;
            transition: 0.2s;
            position: relative;
        }
        .pred-card.active { border-color: var(--blue); background: #2A2A2A; }
        .pred-card.running { border-color: var(--green); background: #2A2A2A; }

        .pred-lbl { font-size: 11px; color: var(--grey); text-transform: uppercase; font-weight: 600; margin-bottom: 6px; letter-spacing: 0.5px; }
        
        .pred-primary { 
            font-size: 34px; 
            font-weight: 300; 
            font-family: monospace; 
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
            line-height: 1.1; 
            white-space: nowrap; 
            min-height: 38px;
        }
        
        .pred-secondary { 
            font-size: 19px; 
            font-weight: 800;
            text-transform: uppercase;
            margin-top: 6px; 
            min-height: 24px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Tables --- */
        .section-header {
            background: #121212;
            color: var(--grey);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 8px 16px;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        .data-table th, .data-table td { padding: 10px 4px; border-bottom: 1px solid var(--border); text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .data-table th { color: var(--grey); font-weight: 500; font-size: 10px; }
        .data-table td:first-child, .data-table th:first-child { text-align: left; padding-left: 12px; width: 12%; }
        /* Columns */
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width: 18%; } /* B-H */
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width: 18%; } /* H-H */
        .data-table th:nth-child(4), .data-table td:nth-child(4) { width: 26%; } /* Est */
        .data-table th:nth-child(5), .data-table td:nth-child(5) { width: 26%; } /* Act */
        
        .mono { font-family: monospace; font-size: 14px; letter-spacing: -0.5px; }

        /* --- State Colors for Time Toggles --- */
        .time-active { color: #FFFFFF; font-weight: 700; cursor: pointer; }
        .time-ignored { color: #444; font-weight: 400; cursor: pointer; text-decoration: none; }
        
        .player-badge {
            font-size: 10px; padding: 3px 4px; border-radius: 4px;
            background: #333; color: #ccc; font-weight: 700; letter-spacing: 0.5px;
        }

        /* --- Controls --- */
        .controls-area {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            border-top: 1px solid var(--border);
            display: flex; gap: 12px; z-index: 100;
        }

        button { border: none; outline: none; cursor: pointer; text-transform: uppercase; -webkit-touch-callout: none; }

        #btn-main {
            flex: 2; height: 72px; border-radius: 18px;
            font-size: 24px; font-weight: 700; color: white;
            background: var(--green);
            box-shadow: 0 4px 15px rgba(48, 209, 88, 0.25);
            transition: transform 0.1s;
        }
        #btn-main:active { transform: scale(0.96); }
        
        #btn-reset {
            flex: 1; height: 72px; border-radius: 18px;
            background: #2C2C2E; color: var(--text);
            font-size: 14px; font-weight: 600;
        }

        .st-ready { background-color: var(--green) !important; }
        .st-split { background-color: var(--blue) !important; box-shadow: 0 4px 15px rgba(10, 132, 255, 0.25) !important; }
        .st-int { background-color: var(--red) !important; box-shadow: 0 4px 15px rgba(255, 69, 58, 0.25) !important; }

        /* --- Modal --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; justify-content: flex-end; z-index: 200;
        }
        .modal-content { background: #1C1C1E; border-radius: 20px 20px 0 0; padding: 24px; border-top: 1px solid #333; }
        .zone-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 16px; }
        .zone-btn {
            padding: 14px 0; background: #2C2C2E; color: white;
            border-radius: 10px; font-weight: 600; font-size: 13px;
        }
        /* Only Tee Line gets color in grid */
        .z-tee { color: var(--green) !important; }
        
    </style>
</head>
<body>

    <header>
        <h1>CurlingPro</h1>
        <select id="profile-select" class="profile-select">
            <option value="TEAM">TEAM (All)</option>
            <option value="-">-</option>
            <option value="Lead">Lead</option>
            <option value="2nd">Second</option>
            <option value="Vice">Vice</option>
            <option value="Skip">Skip</option>
        </select>
    </header>

    <div class="scroll-area">
        
        <div class="readout">
            <div class="dual-pred">
                <!-- Back to Hog Card -->
                <div class="pred-card" id="card-bh">
                    <div class="pred-lbl">Back to Hog</div>
                    <div class="pred-primary" id="time-bh">0.00</div>
                    <div class="pred-secondary" id="pred-bh">--</div>
                </div>
                <!-- Hog to Hog Card -->
                <div class="pred-card" id="card-hh">
                    <div class="pred-lbl">Hog to Hog</div>
                    <div class="pred-primary" id="time-hh">0.00</div>
                    <div class="pred-secondary" id="pred-hh">--</div>
                </div>
            </div>
        </div>

        <div class="section-header">
            <span>Quick Reference</span>
            <span id="ice-readout" style="color:var(--blue)">Neutral</span>
        </div>
        <table class="data-table" id="ref-table">
            <thead>
                <tr>
                    <th>Target</th>
                    <th>B-H</th>
                    <th>H-H</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="section-header" style="margin-top: 10px;">
            <span>Shot History</span>
            <span style="font-size:10px; font-weight:400; color:#666;">White=Used | Grey=Ignored</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Ply</th>
                    <th>B-H</th>
                    <th>H-H</th>
                    <th>Est</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>

    </div>

    <div class="controls-area">
        <button id="btn-reset" onclick="app.reset()">RESET</button>
        <button id="btn-main" class="st-ready">START</button>
    </div>

    <!-- Calibration Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 style="margin:0; font-size:18px;">Actual Result?</h3>
            <p style="margin:5px 0 0 0; font-size:13px; color:var(--grey);">Calibrating for <span id="calib-profile">Team</span></p>
            <div class="zone-grid" id="zone-grid"></div>
            <button onclick="app.closeModal()" style="padding:15px; width:100%; background:transparent; color:var(--grey); margin-top:10px;">Cancel</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            // Physics Constants
            bhSlope: -8.33, bhIntercept: 38.65,
            hhSlope: -7.14, hhIntercept: 110.5,

            // Validity Thresholds
            minBH: 2.0, maxBH: 6.0,
            minHH: 7.0, maxHH: 20.0,

            // Zone Definitions
            zones: {
                13: "NORMAL", 12: "CONTROL", 
                11.5: "BOARD", 11: "THROUGH", 10: "BACK 12", 9: "BACK 8", 8: "BACK 4",
                7: "TEE LINE", 6: "TOP 4", 5: "TOP 8", 4: "TOP 12",
                3: "HOG 12", 2: "GUARD", 1: "HOGGED", 0: "SHORT"
            },
            
            // Reference Table Targets
            refRows: [
                { z: 11.5, n: "BOARD" }, 
                { z: 10, n: "BACK 12" }, 
                { z: 7, n: "TEE LINE" },
                { z: 4, n: "TOP 12" }, 
                { z: 2, n: "GUARD" }
            ]
        };

        const app = {
            state: 'IDLE',
            t0: 0, t1: 0,
            split: 0, interval: 0,
            timerInterval: null,
            history: [],
            currentProfile: 'TEAM',
            iceOffset: 0,
            editingId: null,

            // DOM Elements
            elBtn: document.getElementById('btn-main'),
            elCardBH: document.getElementById('card-bh'),
            elTimeBH: document.getElementById('time-bh'),
            elPredBH: document.getElementById('pred-bh'),
            elCardHH: document.getElementById('card-hh'),
            elTimeHH: document.getElementById('time-hh'),
            elPredHH: document.getElementById('pred-hh'),
            elProfile: document.getElementById('profile-select'),

            init() {
                this.loadData();
                this.setupGrid();
                this.bindEvents();
                this.updateProfile();
                this.renderUI();
            },

            bindEvents() {
                const btn = document.getElementById('btn-main');
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); this.handleAction(); }, {passive: false});
                btn.addEventListener('click', (e) => { if(e.detail !== 0) { e.preventDefault(); this.handleAction(); }});
                
                this.elProfile.addEventListener('change', (e) => {
                    this.currentProfile = e.target.value;
                    this.updateProfile();
                    this.renderUI();
                });
            },

            setupGrid() {
                const container = document.getElementById('zone-grid');
                const order = [13, 12, 11.5, 10, 8, 7, 6, 4, 2];
                order.forEach(z => {
                    const btn = document.createElement('button');
                    btn.className = 'zone-btn';
                    btn.innerText = CONFIG.zones[z] || z;
                    if(z === 7) btn.classList.add('z-tee'); // Only Tee Line gets color
                    btn.onclick = () => this.calibrate(z);
                    container.appendChild(btn);
                });
            },

            handleAction() {
                const now = Date.now();
                if (this.state === 'IDLE') {
                    // START
                    this.state = 'RUNNING';
                    this.t0 = now;
                    this.startTimer();
                    this.updateBtn("HOG 1", "st-split");
                    
                    // Visuals
                    this.elCardBH.classList.add('running');
                    this.elPredBH.innerText = "Timing...";
                    this.elTimeBH.style.color = "var(--text)";
                    
                    // Reset H-H
                    this.elTimeHH.innerText = "0.00"; 
                    this.elPredHH.innerText = "--";
                    this.elPredHH.style.color = "var(--grey)";
                    
                    this.vibrate(15);

                } else if (this.state === 'RUNNING') {
                    // SPLIT (Back to Hog Done)
                    this.t1 = now;
                    this.split = (this.t1 - this.t0) / 1000;
                    this.state = 'INTERVAL';
                    
                    // Visuals: Lock B-H
                    this.elCardBH.classList.remove('running');
                    this.elCardBH.classList.add('active');
                    this.elTimeBH.innerText = this.split.toFixed(2);
                    this.predictBH(this.split); 
                    
                    // Visuals: Start H-H
                    this.elCardHH.classList.add('running');
                    this.elPredHH.innerText = "Timing...";
                    
                    this.updateBtn("HOG 2", "st-int");
                    this.vibrate(30);

                } else if (this.state === 'INTERVAL') {
                    // FINISH (Hog to Hog Done)
                    this.interval = (now - this.t1) / 1000;
                    this.state = 'FINISHED';
                    this.stopTimer();
                    
                    // Visuals: Lock H-H
                    this.elCardHH.classList.remove('running');
                    this.elCardHH.classList.add('active');
                    this.elTimeHH.innerText = this.interval.toFixed(2);
                    this.predictHH(this.interval); 
                    
                    this.updateBtn("NEXT SHOT", "st-ready");
                    this.saveShot();
                    this.vibrate([10, 30, 10]);

                } else if (this.state === 'FINISHED') {
                    this.reset();
                }
            },

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    const now = Date.now();
                    if (this.state === 'RUNNING') {
                        const t = (now - this.t0) / 1000;
                        this.elTimeBH.innerText = t.toFixed(2);
                    } else if (this.state === 'INTERVAL') {
                        const t = (now - this.t1) / 1000;
                        this.elTimeHH.innerText = t.toFixed(2);
                    }
                }, 37);
            },
            stopTimer() { clearInterval(this.timerInterval); },

            reset() {
                this.stopTimer();
                this.state = 'IDLE';
                this.elTimeBH.innerText = "0.00"; this.elPredBH.innerText = "--";
                this.elTimeHH.innerText = "0.00"; this.elPredHH.innerText = "--";
                this.elCardBH.className = 'pred-card';
                this.elCardHH.className = 'pred-card';
                this.elPredBH.style.color = "var(--grey)";
                this.elPredHH.style.color = "var(--grey)";
                this.updateBtn("START", "st-ready");
            },

            updateBtn(text, cls) {
                this.elBtn.className = '';
                this.elBtn.classList.add(cls);
                this.elBtn.innerText = text;
            },

            // --- PREDICTION ---
            predictBH(time) {
                if (time < CONFIG.minBH || time > CONFIG.maxBH) {
                    this.elPredBH.innerText = "-";
                    this.elPredBH.style.color = "var(--grey)";
                    return null;
                }
                const z = (CONFIG.bhSlope * time) + CONFIG.bhIntercept + this.iceOffset;
                const final = this.resolveZone(z);
                this.displayPred(this.elPredBH, final);
                return final;
            },

            predictHH(time) {
                if (time < CONFIG.minHH || time > CONFIG.maxHH) {
                    this.elPredHH.innerText = "-";
                    this.elPredHH.style.color = "var(--grey)";
                    return null;
                }
                const z = (CONFIG.hhSlope * time) + CONFIG.hhIntercept + this.iceOffset;
                const final = this.resolveZone(z);
                this.displayPred(this.elPredHH, final);
                return final;
            },

            resolveZone(z) {
                if (z > 12.5) return 13; // Normal
                if (z > 11.8) return 12; // Control
                return Math.max(0, Math.min(11.5, z));
            },

            displayPred(el, zVal) {
                const r = Math.round(zVal);
                const txt = CONFIG.zones[zVal] || CONFIG.zones[r] || "UNKNOWN";
                el.innerText = txt;
                
                // Color Logic: ONLY TEE LINE (7) is Green.
                if (r === 7) el.style.color = "var(--green)";
                else el.style.color = "var(--text)";
            },

            saveShot() {
                const isValidBH = this.split >= CONFIG.minBH && this.split <= CONFIG.maxBH;
                const isValidHH = this.interval >= CONFIG.minHH && this.interval <= CONFIG.maxHH;

                let p = this.currentProfile;
                if(p === 'TEAM') p = '-'; 

                const s = {
                    id: Date.now(),
                    player: p,
                    bh: this.split,
                    hh: this.interval,
                    actual: null,
                    useBH: isValidBH,
                    useHH: isValidHH,
                    rawBH: (CONFIG.bhSlope * this.split) + CONFIG.bhIntercept,
                    rawHH: (CONFIG.hhSlope * this.interval) + CONFIG.hhIntercept
                };
                
                this.history.unshift(s);
                if (this.history.length > 50) this.history.pop();
                this.saveStorage();
                this.updateProfile();
                this.renderUI();
            },

            updateProfile() {
                const shots = this.currentProfile === 'TEAM' 
                    ? this.history 
                    : this.history.filter(s => s.player === this.currentProfile);
                
                let errSum = 0;
                let count = 0;

                shots.forEach(s => {
                    if (s.actual !== null && s.actual <= 11.5) {
                        if (s.useBH) { errSum += (s.actual - s.rawBH); count++; }
                        if (s.useHH) { errSum += (s.actual - s.rawHH); count++; }
                    }
                });

                this.iceOffset = count > 0 ? (errSum / count) : 0;
                const sign = this.iceOffset > 0 ? "+" : "";
                document.getElementById('ice-readout').innerText = count > 0 
                    ? `${this.currentProfile}: ${sign}${this.iceOffset.toFixed(1)}` 
                    : "Neutral";
            },

            toggleTime(id, type) {
                const s = this.history.find(x => x.id === id);
                if(s) {
                    if(type === 'bh') s.useBH = !s.useBH;
                    if(type === 'hh') s.useHH = !s.useHH;
                    this.saveStorage();
                    this.updateProfile();
                    this.renderUI();
                }
            },

            cyclePlayer(id) {
                const roles = ['-', 'Lead', '2nd', 'Vice', 'Skip'];
                const s = this.history.find(x => x.id === id);
                if(s) {
                    const idx = roles.indexOf(s.player);
                    const currentIdx = idx === -1 ? 0 : idx;
                    s.player = roles[(currentIdx + 1) % roles.length];
                    this.saveStorage();
                    this.updateProfile();
                    this.renderUI();
                }
            },

            openModal(id) {
                this.editingId = id;
                const s = this.history.find(x => x.id === id);
                document.getElementById('calib-profile').innerText = s.player;
                document.getElementById('modal').style.display = 'flex';
            },
            closeModal() { document.getElementById('modal').style.display = 'none'; this.editingId = null; },

            calibrate(val) {
                const s = this.history.find(x => x.id === this.editingId);
                if(s) {
                    s.actual = val;
                    if (s.bh >= CONFIG.minBH && s.bh <= CONFIG.maxBH) s.useBH = true;
                    if (s.hh >= CONFIG.minHH && s.hh <= CONFIG.maxHH) s.useHH = true;
                    this.saveStorage();
                    this.updateProfile();
                    this.renderUI();
                }
                this.closeModal();
            },

            renderUI() {
                // --- Ref Table ---
                const tbRef = document.getElementById('ref-table').querySelector('tbody');
                tbRef.innerHTML = '';
                CONFIG.refRows.forEach(r => {
                    const bh = (r.z - this.iceOffset - CONFIG.bhIntercept) / CONFIG.bhSlope;
                    const hh = (r.z - this.iceOffset - CONFIG.hhIntercept) / CONFIG.hhSlope;
                    
                    let color = "var(--text)";
                    if (r.z === 7) color = "var(--green)";

                    tbRef.innerHTML += `<tr>
                        <td style="font-weight:700; color:${color}">${r.n}</td>
                        <td class="mono">${bh.toFixed(2)}</td>
                        <td class="mono">${hh.toFixed(2)}</td>
                    </tr>`;
                });

                // --- History ---
                const tbHist = document.getElementById('history-body');
                tbHist.innerHTML = '';
                const visible = this.currentProfile === 'TEAM' 
                    ? this.history 
                    : this.history.filter(s => s.player === this.currentProfile);

                visible.forEach(s => {
                    // 1. Calculate Est Column
                    let estHtml = '<span style="color:#444">-</span>';
                    let pVal = 0;
                    let hasPred = false;
                    
                    if (s.useHH) { pVal = this.resolveZone(s.rawHH + this.iceOffset); hasPred = true; }
                    else if (s.useBH) { pVal = this.resolveZone(s.rawBH + this.iceOffset); hasPred = true; }

                    if (hasPred) {
                        const pName = CONFIG.zones[pVal] || "?";
                        let pCol = "var(--text)";
                        if (Math.round(pVal) === 7) pCol = "var(--green)"; // Green for Tee
                        estHtml = `<span style="color:${pCol}; font-weight:700;">${pName}</span>`;
                    }

                    // 2. Calculate Result Column
                    let resHtml = '<span style="color:#444; font-size:16px;">-</span>';
                    if (s.actual !== null) {
                        const zName = CONFIG.zones[s.actual] || s.actual;
                        let zCol = "var(--text)";
                        if (Math.round(s.actual) === 7) zCol = "var(--green)"; // Green for Tee
                        resHtml = `<span style="color:${zCol}; font-weight:700;">${zName}</span>`;
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="player-badge" onclick="app.cyclePlayer(${s.id})">${s.player.substring(0,4).toUpperCase()}</span></td>
                        <td class="mono ${s.useBH ? 'time-active' : 'time-ignored'}" onclick="app.toggleTime(${s.id}, 'bh')">${s.bh.toFixed(2)}</td>
                        <td class="mono ${s.useHH ? 'time-active' : 'time-ignored'}" onclick="app.toggleTime(${s.id}, 'hh')">${s.hh.toFixed(2)}</td>
                        <td>${estHtml}</td>
                        <td onclick="app.openModal(${s.id})">${resHtml}</td>
                    `;
                    tbHist.appendChild(tr);
                });
            },

            vibrate(p) { if(navigator.vibrate) navigator.vibrate(p); },
            saveStorage() { localStorage.setItem('cp_v7_final', JSON.stringify(this.history)); },
            loadData() { 
                const d = localStorage.getItem('cp_v7_final'); 
                if(d) this.history = JSON.parse(d); 
            }
        };

        app.init();
    </script>
</body>
</html>