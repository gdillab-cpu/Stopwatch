<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Curling Pro v7.5</title>
    <style>
        :root { --primary: #0056b3; --success: #28a745; --warning: #ffc107; --danger: #dc3545; --bg: #f0f2f5; --card: #ffffff; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); margin: 0; padding: 10px; color: #333;
            touch-action: manipulation; user-select: none;
        }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 40px; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; }
        
        #js-status { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: #28a745; color: white; float: right; }

        /* Timer Displays */
        .timer-container { display: flex; justify-content: space-around; align-items: center; margin: 10px 0; }
        .timer-sub { text-align: center; flex: 1; }
        .timer-label { font-size: 0.7rem; font-weight: bold; color: #666; text-transform: uppercase; }
        .timer-val { font-size: 2.5rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums; }
        .timer-main { font-size: 5rem; line-height: 1; margin: 10px 0; }

        .pred-box { text-align: center; background: #e7f3ff; border: 2px solid var(--primary); border-radius: 12px; padding: 10px; margin-bottom: 10px; }
        .pred-val { font-size: 2rem; font-weight: bold; color: var(--primary); display: block; }

        /* Multi-Stage Button */
        .btn-main { 
            background: var(--success); color: white; border: none; 
            padding: 30px; border-radius: 16px; font-size: 1.6rem; 
            font-weight: 900; width: 100%; margin: 10px 0; 
            cursor: pointer; display: block; box-shadow: 0 6px 0 #1e7e34;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 #1e7e34; }
        .btn-stage2 { background: var(--warning); color: black; box-shadow: 0 6px 0 #d39e00; }
        .btn-stop { background: var(--danger); box-shadow: 0 6px 0 #bd2130; }
        
        .btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-sub { flex: 1; padding: 18px; border-radius: 12px; border: none; background: #6c757d; color: white; font-weight: bold; font-size: 1.1rem; }

        /* Compact History Table */
        .history-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
        .history-table th { text-align: left; padding: 8px; border-bottom: 2px solid #eee; color: #666; }
        .history-table td { padding: 10px 6px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .use-toggle { width: 20px; height: 20px; vertical-align: middle; }
        .toggle-label { font-size: 0.6rem; color: #999; display: block; margin-top: 2px; }

        .speed-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
        .speed-table td, .speed-table th { border: 1px solid #eee; padding: 8px; text-align: center; }
        .highlight { font-weight: 800; color: var(--primary); }

        #calib-modal { 
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 999; align-items: center; justify-content: center; 
        }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; }
        select { width: 100%; padding: 18px; font-size: 1.2rem; border-radius: 12px; margin: 15px 0; border: 2px solid #ddd; background: #fff; }
    </style>
</head>
<body>

<div class="container">
    <div class="card" style="padding: 10px;">
        <span id="js-status">JS: ACTIVE</span>
        <select id="player-select" style="width: 60%; border:none; font-weight: 800; font-size: 1.1rem; background: transparent;">
            <option value="Team">üèÜ Team Profile</option>
            <option value="Skip">Skip</option><option value="Vice">Vice</option>
            <option value="Second">Second</option><option value="Lead">Lead</option>
        </select>
    </div>

    <div class="card">
        <div class="timer-container">
            <div class="timer-sub">
                <div class="timer-label">Back-Hog (Split)</div>
                <div id="b2h-val" class="timer-val">0.00</div>
            </div>
            <div class="timer-sub">
                <div class="timer-label">Hog-Hog (Ice)</div>
                <div id="h2h-val" class="timer-val">0.00</div>
            </div>
        </div>
    </div>

    <div class="pred-box">
        <span id="pred-label" style="font-size: 0.8rem; text-transform: uppercase; color: #666; font-weight: 700;">Prediction (Split-Based)</span>
        <span class="pred-val" id="pred-text">--</span>
    </div>

    <button id="btn-action" class="btn-main">START</button>

    <div class="btn-row">
        <button id="btn-reset" class="btn-sub">Reset</button>
        <button id="btn-cal-last" class="btn-sub" style="background:#ffc107; color:black;">Calibrate</button>
    </div>

    <div class="card">
        <div style="font-weight: bold; margin-bottom: 8px; display:flex; justify-content: space-between;">
            <span>SHOT HISTORY</span>
            <span style="font-size: 0.7rem; color: var(--primary);">Tap row to adjust</span>
        </div>
        <table class="history-table">
            <thead>
                <tr>
                    <th>Split (B-H)</th>
                    <th>Hog-Hog</th>
                    <th>Actual</th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>
        <div id="empty-msg" style="padding: 20px; text-align: center; color: #999; font-style: italic;">No shots recorded</div>
    </div>

    <div class="card">
        <div style="font-weight: bold; margin-bottom: 8px;">LIVE SPEED ESTIMATES (By Profile)</div>
        <table class="speed-table">
            <thead>
                <tr><th>Target</th><th>Split</th><th>Hog-Hog</th></tr>
            </thead>
            <tbody id="speed-sheet-body"></tbody>
        </table>
    </div>
</div>

<div id="calib-modal">
    <div class="modal-content">
        <h2 style="margin-top:0">Set Actual Result</h2>
        <p>Player: <b id="m-player"></b></p>
        <select id="calib-zone">
            <option value="12">Board Weight</option>
            <option value="10">Back 12</option>
            <option value="7">TEE LINE</option>
            <option value="4">Top 12</option>
            <option value="1">Hogged</option>
        </select>
        <button id="btn-save-cal" class="btn-main" style="padding: 20px;">Save Result</button>
        <button id="btn-cancel-cal" style="background:none; border:none; color: #dc3545; width:100%; padding: 15px; font-weight: bold;">Cancel</button>
    </div>
</div>

<script>
    // --- Physics ---
    const n = 6.0; 
    const ZONES = { 12:"BOARD", 10:"Back 12", 7:"TEE LINE", 4:"Top 12", 1:"Hogged" };
    
    // --- Application State ---
    let allShots = [];
    let state = "READY"; // READY -> B2H -> H2H
    let timerStart = 0;
    let b2h_final = 0;
    let h2h_final = 0;
    let interval = null;
    let editingId = null;

    const b2hEl = document.getElementById('b2h-val');
    const h2hEl = document.getElementById('h2h-val');
    const actionBtn = document.getElementById('btn-action');

    function getActivePlayer() { return document.getElementById('player-select').value; }

    // --- Dynamic Physics Engine ---
    function getConstants() {
        const player = getActivePlayer();
        const pool = (player === 'Team') ? allShots : allShots.filter(s => s.player === player);
        
        // Split Constant (C_b2h)
        let cb_tw = 0, cb_tc = 0;
        pool.filter(s => s.b2h_use && s.actualZone).slice(-10).forEach((s, i) => {
            let w = i + 1; cb_tc += (s.actualZone * Math.pow(s.b2h, n)) * w; cb_tw += w;
        });
        const C_b2h = cb_tw > 0 ? cb_tc / cb_tw : 7 * Math.pow(3.75, n);

        // Ice Constant (C_h2h) for Live Speed Table
        let ch_tw = 0, ch_tc = 0;
        pool.filter(s => s.h2h_use && s.h2h > 0).slice(-10).forEach((s, i) => {
            let w = i + 1; ch_tc += s.h2h * w; ch_tw += w;
        });
        const avg_h2h = ch_tw > 0 ? ch_tc / ch_tw : 14.5; // Default H2H baseline

        return { C_b2h, avg_h2h };
    }

    // --- Timer Handling ---
    function handleTap(e) {
        if(e) e.preventDefault();
        
        if (state === "READY") {
            timerStart = Date.now();
            state = "B2H";
            actionBtn.innerText = "HOG 1 (STOP SPLIT)";
            actionBtn.className = "btn-main btn-stage2";
            interval = setInterval(updateTimers, 30);
        } 
        else if (state === "B2H") {
            b2h_final = (Date.now() - timerStart) / 1000;
            timerStart = Date.now(); // Reset start for H2H
            state = "H2H";
            actionBtn.innerText = "HOG 2 (STOP H2H)";
            actionBtn.className = "btn-main btn-stop";
            
            // Prediction based on Split
            const { C_b2h } = getConstants();
            const pred = Math.min(12, Math.max(1, Math.round(C_b2h / Math.pow(b2h_final, n))));
            document.getElementById('pred-text').innerText = ZONES[pred] || "Guard";
        } 
        else if (state === "H2H") {
            clearInterval(interval);
            h2h_final = (Date.now() - timerStart) / 1000;
            state = "READY";
            actionBtn.innerText = "START NEW SHOT";
            actionBtn.className = "btn-main";
            
            saveShot();
        }
    }

    function updateTimers() {
        const now = Date.now();
        const diff = (now - timerStart) / 1000;
        if (state === "B2H") b2hEl.innerText = diff.toFixed(2);
        if (state === "H2H") h2hEl.innerText = diff.toFixed(2);
    }

    function saveShot() {
        const { C_b2h } = getConstants();
        const pred = Math.min(12, Math.max(1, Math.round(C_b2h / Math.pow(b2h_final, n))));
        
        allShots.push({
            id: Date.now(),
            player: getActivePlayer(),
            b2h: b2h_final,
            h2h: h2h_final,
            pred: pred,
            actualZone: null,
            b2h_use: true,
            h2h_use: true
        });
        renderAll();
    }

    function renderAll() {
        const { C_b2h, avg_h2h } = getConstants();
        const active = getActivePlayer();
        const filtered = (active === 'Team') ? [...allShots] : allShots.filter(s => s.player === active);
        
        // History
        const body = document.getElementById('history-body');
        body.innerHTML = "";
        document.getElementById('empty-msg').style.display = filtered.length ? 'none' : 'block';
        
        [...filtered].reverse().slice(0, 6).forEach(s => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-id', s.id);
            tr.innerHTML = `
                <td style="${!s.b2h_use ? 'opacity:0.3' : ''}">
                    <input type="checkbox" class="tgl-b" ${s.b2h_use?'checked':''} data-id="${s.id}">
                    <b>${s.b2h.toFixed(2)}s</b>
                    <span class="toggle-label">${s.player}</span>
                </td>
                <td style="${!s.h2h_use ? 'opacity:0.3' : ''}">
                    <input type="checkbox" class="tgl-h" ${s.h2h_use?'checked':''} data-id="${s.id}">
                    <b>${s.h2h > 0 ? s.h2h.toFixed(2)+'s' : '--'}</b>
                </td>
                <td>${s.actualZone ? `<b>${ZONES[s.actualZone]}</b>` : `<span style="color:#999">Tap to set</span>`}</td>
            `;
            body.appendChild(tr);
        });

        // Live Estimates
        const sheet = document.getElementById('speed-sheet-body');
        sheet.innerHTML = "";
        [12, 10, 7, 4, 1].forEach(z => {
            const split = Math.pow(C_b2h / z, 1/n);
            // Dynamic ratio: use H2H avg relative to Tee Line split
            const tee_split = Math.pow(C_b2h / 7, 1/n);
            const ratio = avg_h2h / tee_split;
            const h2h_est = split * ratio;
            
            sheet.innerHTML += `<tr><td>${ZONES[z]}</td><td class="highlight">${split.toFixed(2)}s</td><td>${h2h_est.toFixed(2)}s</td></tr>`;
        });
    }

    // --- Listeners ---
    actionBtn.addEventListener('touchstart', handleTap);
    actionBtn.addEventListener('mousedown', handleTap);

    document.getElementById('btn-reset').onclick = () => {
        clearInterval(interval);
        state = "READY";
        b2hEl.innerText = "0.00"; h2hEl.innerText = "0.00";
        actionBtn.innerText = "START"; actionBtn.className = "btn-main";
    };

    document.getElementById('history-body').onclick = (e) => {
        const id = parseInt(e.target.closest('tr')?.getAttribute('data-id'));
        if(!id) return;
        const s = allShots.find(x => x.id === id);
        
        if (e.target.classList.contains('tgl-b')) { s.b2h_use = e.target.checked; renderAll(); }
        else if (e.target.classList.contains('tgl-h')) { s.h2h_use = e.target.checked; renderAll(); }
        else { openCalib(id); }
    };

    function openCalib(id) {
        editingId = id;
        const s = allShots.find(x => x.id === id);
        document.getElementById('m-player').innerText = s.player;
        document.getElementById('calib-zone').value = s.actualZone || s.pred;
        document.getElementById('calib-modal').style.display = 'flex';
    }

    document.getElementById('btn-save-cal').onclick = () => {
        const s = allShots.find(x => x.id === editingId);
        if(s) { s.actualZone = parseInt(document.getElementById('calib-zone').value); s.b2h_use = true; }
        document.getElementById('calib-modal').style.display = 'none';
        renderAll();
    };
    
    document.getElementById('btn-cancel-cal').onclick = () => document.getElementById('calib-modal').style.display = 'none';
    document.getElementById('player-select').onchange = renderAll;

</script>
</body>
</html>