<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Curling Stopwatch — Fixed</title>
<style>
:root{--primary:#0b61b1;--accent:#28a745;--warn:#f0ad4e;--danger:#d9534f;--bg:#f6f8fa;--card:#fff}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:#222;padding-bottom:140px}
.container{max-width:560px;margin:8px auto;padding:10px}
.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.timer{font-size:3.8rem;font-weight:800;text-align:center;letter-spacing:0.5px}
.sub{display:flex;justify-content:space-between;color:#666;font-weight:600;margin-top:8px}
.pred{background:#e9f3ff;border:2px solid var(--primary);padding:10px;border-radius:10px;text-align:center}
.pred .val{font-size:1.6rem;font-weight:800;color:var(--primary);display:block;margin-top:6px}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:0.92rem}
.table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:center}
.thumbbar{position:fixed;left:0;right:0;bottom:0;padding:14px;background:linear-gradient(to top,#fff 75%,rgba(255,255,255,0))}
.btn{width:100%;padding:22px;border-radius:14px;border:none;font-weight:900;font-size:1.5rem;background:var(--accent);color:#fff;box-shadow:0 6px 0 #1f7a36}
.btn.split{background:var(--warn);color:#000;box-shadow:0 6px 0 #c78711}
.btn.stop{background:var(--danger);box-shadow:0 6px 0 #a02521}
.small{font-size:0.86rem;color:#666}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:50}
.modal .card{max-width:420px;width:92%}
input[type="checkbox"]{width:18px;height:18px}
select{padding:10px;border-radius:8px;border:1px solid #ddd;width:100%;font-size:1rem}
.row-click{cursor:pointer}
.label-abbrev{font-weight:700}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <select id="playerSelect" aria-label="Player profile">
      <option>Team</option>
      <option>Skip</option>
      <option>Vice</option>
      <option>Second</option>
      <option>Lead</option>
    </select>
  </div>

  <div class="card">
    <div class="timer" id="mainTime">0.00</div>
    <div class="sub"><div>B–H: <span id="b2h">0.00</span></div><div>H–H: <span id="h2h">0.00</span></div></div>
  </div>

  <div class="card pred">
    Prediction
    <span class="val" id="prediction">—</span>
  </div>

  <div class="card">
    <strong>Live Split Estimates</strong>
    <table class="table" id="liveTable"><thead><tr><th>Target</th><th>Split (B–H)</th></tr></thead><tbody></tbody></table>
    <div class="small">Estimates update as you calibrate shots (use toggles to ignore outliers).</div>
  </div>

  <div class="card">
    <strong>Shot History — Tap a row to set actual</strong>
    <table class="table">
      <thead><tr><th>P</th><th>B–H</th><th>Use</th><th>H–H</th><th>Use</th><th>Actual</th></tr></thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>
</div>

<div class="thumbbar">
  <button id="actionBtn" class="btn">START</button>
</div>

<!-- Calibration modal -->
<div id="calibModal" class="modal" role="dialog" aria-modal="true">
  <div class="card">
    <h3 style="margin-top:0">Set Actual Result</h3>
    <div style="margin-bottom:8px">Player: <strong id="modalPlayer"></strong></div>
    <select id="actualSelect" aria-label="Actual shot result"></select>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="saveActualBtn" class="btn" style="flex:1">Save</button>
      <button id="cancelActualBtn" class="btn" style="flex:1;background:#eee;color:#111;box-shadow:none">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ====== Configuration / Constants ====== */
const n = 6.0;                      // exponent (empirical)
const ICE_BASELINE = 14.0;          // reference hog-hog baseline (seconds)
const DEFAULT_B2H = 3.8;            // initial draw split baseline
const DEFAULT_INDEX = 9;            // default distance index / tuning (mid-tee/back12)
const DEFAULT_C = DEFAULT_INDEX * Math.pow(DEFAULT_B2H, n); // baseline constant (C)

/* Zones: index increases with distance (higher index => farther) */
const ZONES = [
  {index:2, label:'High Guard'},
  {index:4, label:'Top 12'},
  {index:6, label:'Tee'},
  {index:8, label:'Back 12'},
  {index:10, label:'Board'},
  {index:12, label:'Control'},
  {index:14, label:'Normal'},
  {index:16, label:'Peel'}
];

/* ====== State ====== */
let shots = [];          // {id, player, b2h, h2h, actual (index|null), useB, useH}
let state = 'READY';     // READY -> B2H -> H2H
let t0 = 0;
let curB2H = 0;
let curH2H = 0;
let timerInt = null;
let editingIndex = null; // index in shots[] of row being edited

/* ====== Cached DOM references (grab these once) ====== */
const playerSelect = document.getElementById('playerSelect');
const mainTimeEl   = document.getElementById('mainTime');
const b2hEl        = document.getElementById('b2h');
const h2hEl        = document.getElementById('h2h');
const predictionEl = document.getElementById('prediction');
const liveTableTbody = document.querySelector('#liveTable tbody');
const historyBody  = document.getElementById('historyBody');
const actionBtn    = document.getElementById('actionBtn');
const calibModal   = document.getElementById('calibModal');
const actualSelect = document.getElementById('actualSelect');
const modalPlayer  = document.getElementById('modalPlayer');
const saveActualBtn = document.getElementById('saveActualBtn');
const cancelActualBtn = document.getElementById('cancelActualBtn');

/* populate actualSelect options */
(function populateActualOptions(){
  actualSelect.innerHTML = '';
  ZONES.forEach(z=>{
    const o = document.createElement('option');
    o.value = z.index;
    o.textContent = z.label;
    actualSelect.appendChild(o);
  });
})();

/* ====== Utility / Model functions ====== */

/**
 * Compute model constants from shots that have actual result and are marked 'use'
 * We compute weighted average:
 *   C ≈ sum(actual_index * b2h^n * weight) / sum(weight)
 * and an avg H2H to later use as ice multiplier if required.
 */
function getConstants(){
  // Shots used for learning: must have actual set and both use toggles true (or at least one -- choose to require both used)
  const learn = shots.filter(s => s.actual != null && s.useB && s.useH);
  if (!learn.length) {
    return { C: DEFAULT_C, avgH2H: ICE_BASELINE };
  }
  let cSum = 0, wSum = 0, h2hSum = 0;
  const slice = learn.slice(-12); // recent up to 12 shots
  slice.forEach((s, i) => {
    const weight = i + 1; // more recent => higher weight
    cSum += (s.actual * Math.pow(s.b2h, n)) * weight;
    h2hSum += s.h2h * weight;
    wSum += weight;
  });
  const avgH2H = (h2hSum / wSum) || ICE_BASELINE;
  const baseC = (cSum / wSum) || DEFAULT_C;
  // Scale C by ice factor: if avgH2H > baseline, ice is faster (stones travel farther), so scale up
  const iceFactor = avgH2H / ICE_BASELINE;
  const C = baseC * iceFactor;
  return { C, avgH2H };
}

/** Predict zone object from a measured b2h time */
function predictZoneFromB2H(b2h){
  if(!b2h || b2h <= 0) return null;
  const { C } = getConstants();
  // idx increases with smaller b2h (faster split => farther)
  const idx = C / Math.pow(b2h, n);
  // pick closest zone by index distance
  let best = ZONES[0];
  let bestDiff = Math.abs(ZONES[0].index - idx);
  for (let i = 1; i < ZONES.length; i++){
    const d = Math.abs(ZONES[i].index - idx);
    if(d < bestDiff){ best = ZONES[i]; bestDiff = d; }
  }
  return { zone: best, idx };
}

/** Update live reference table (High Guard, Top 12, Tee, Back 12, Board) */
function updateLiveTable(){
  const { C } = getConstants();
  cons
